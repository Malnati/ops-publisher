<!-- README.md -->
<div align="center">

# ‚öôÔ∏è Ops Publisher

**Automate publishing GitOps artifacts via Derived Pull Requests**

[![GitHub Release](https://img.shields.io/github/v/release/Malnati/ops-publisher?style=for-the-badge&color=0052CC&logo=github)](https://github.com/Malnati/ops-publisher/releases)
[![License](https://img.shields.io/github/license/Malnati/ops-publisher?style=for-the-badge&color=grey)](LICENSE)

<p align="center">
  <a href="#-how-it-works">How It Works</a> ‚Ä¢
  <a href="#-quick-start">Quick Start</a> ‚Ä¢
  <a href="#-configuration">Configuration</a> ‚Ä¢
  <a href="#-templates">Templates</a>
</p>

<p align="center">
  <img src="assets/ops-publisher-splash-original.png" alt="Ops Publisher splash with GitOps publishing concept" width="780" />
</p>

</div>

---

## üöÄ About

**Ops Publisher** is a GitHub Action designed for advanced GitOps flows. It captures a file generated in your workflow
 (Markdown, JSON, CSV, etc.), commits it to an isolated branch, and manages a **Derived Pull Request** that points back to the
source PR branch.

It is the ideal solution for attaching CI reports, Terraform plans, or build artifacts directly in the PR context without
polluting the main history immediately.

## üß† How It Works

The action runs a "Sidecar PR" workflow:

1.  **Validation:** Checks inputs and metadata from the source PR.
2.  **Branching:** Calculates a unique branch based on the commit SHA (`ops/files/<sha-hash>`).
3.  **Commit:** Sends the selected file to this new branch.
4.  **Derived PR:** Creates (or updates) a PR proposing to merge the publishing branch into the source PR branch.
5.  **Notification:** Comments on the source PR timeline with the link to the generated artifact.

---

## ‚ú® Features

* ‚úÖ **Automatic PR Management:** Intelligent creation and reuse of Pull Requests.
* ‚úÖ **Dynamic Templating:** Renders PR bodies and comments using environment variables.
* ‚úÖ **Traceability:** Centralized error logs and direct links in the timeline.
* ‚úÖ **Security:** Support for custom tokens and granular permissions.

---

## ‚ö° Quick Start

Add this step to your workflow. Make sure to configure the required permissions.

### Prerequisites
```yaml
permissions:
  contents: write
  pull-requests: write
````

### Workflow Example

This example generates a report and publishes it whenever a comment is made on the PR.

```yaml
name: "Publish Report"
on:
  issue_comment:
    types: [created]

jobs:
  publish:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0 # Essential for calculating git history

      - name: üìù Generate Report
        run: |
          mkdir -p .reports
          echo "# Execution Report" > .reports/report.md
          date >> .reports/report.md

      - name: ‚öôÔ∏è Ops Publisher
        uses: Malnati/ops-publisher@v3.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.issue.number }}
          attached_file_path: .reports/report.md
          pr_template_path: .github/templates/report-pr.md
          timeline_template_path: .github/templates/report-timeline.md
          # Optional
          pr_title: "üìã Automated Report"
          branch_convention_prefix: ops/reports
          bot_name: ops-bot
          bot_email: bot@company.com
```

-----

## üì¶ Configuration (Inputs)

| Input | Required | Default | Description |
| :--- | :---: | :--- | :--- |
| `token` | **Yes** | - | GitHub token (e.g., `secrets.GITHUB_TOKEN`). |
| `pr_number` | **Yes** | - | Source PR number (accepts `N` or `#N`). |
| `attached_file_path` | **Yes** | - | Path to the file to be published. |
| `pr_template_path` | **Yes** | - | Path to the Markdown template for the derived PR body. |
| `timeline_template_path` | **Yes** | - | Path to the Markdown template for the comment on the source PR. |
| `branch_convention_prefix` | No | `ops/files` | Prefix used to organize branches. |
| `pr_title` | No | `üõ°Ô∏è Automated PR` | Title for the derived PR. |
| `bot_name` | No | `git-pr-ops-bot` | Name of the git commit author. |
| `bot_email` | No | `...` | Email of the git commit author. |
| `errors` | No | `.github/...` | File used to centralize error logs. |

-----

## üé® Customizing Templates

The Action uses **Malnati/templateer** to render variables in your Markdown files.

### Available Variables

| Variable | Description | Available in |
| :--- | :--- | :--- |
| `${ATTACHED_FILE_PATH}` | File name/path | Both |
| `${PR_NUMBER}` | Original PR number | Both |
| `${BRANCH_CONVENTION}` | Generated branch name | Both |
| `${PR_URL}` | Derived PR URL | **Timeline** only |

### Examples

#### `.github/templates/report-pr.md` (PR Body)

```markdown
# üìé Published File
This Pull Request contains the automatic update of the file:
- **File:** `${ATTACHED_FILE_PATH}`
- **Source:** PR #${PR_NUMBER}

> *Automatically generated by Ops Publisher*
```

#### `.github/templates/report-timeline.md` (Comment)

```markdown
‚úÖ **Report Generated Successfully!**

A new version of `${ATTACHED_FILE_PATH}` is available for review.
üîó **View Derived Pull Request:** ${PR_URL}
```

-----

## ‚ö†Ô∏è Important Notes

1.  **Sensitive Data:** The file at `attached_file_path` is committed **as is**. Do not use it for secrets or private keys.
2.  **PR Chain:** The derived PR attempts to merge the `ops/...` branch back into the source PR branch.
3.  **Fetch Depth:** Always use `fetch-depth: 0` in the checkout to ensure the action can correctly compute the git tree.

-----

<div align="right"> <sub>Maintained by <a href="https://github.com/Malnati">Malnati</a></sub> </div>
