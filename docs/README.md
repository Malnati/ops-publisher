<!-- docs/README.md -->
# Ops Publisher

**Ops Publisher** is a GitHub Action that publishes any repository file (Markdown/JSON/CSV/etc) to a **dedicated branch** and creates (or reuses) a **derived Pull Request**, while also posting a **timeline message** on the source PR using a template.

![Ops Publisher overview showing the derived PR workflow](../assets/ops-publisher-whatisit-original.png)

## How it works

1. Reads the source PR via `pr_number` (uses `gh pr view`) and retrieves:
   - `headRefName` (source branch of the PR)
   - `baseRefName` (destination branch of the PR)
2. Calculates a publication branch:
   - `branch_convention_prefix/<last-10-of-HEAD-sha>`
3. Commits the file at `attached_file_path` to this branch and pushes it.
4. Creates or reuses a derived PR:
   - `base = headRefName` from the source PR
   - `head = publication branch`
5. Renders templates (PR body and timeline) and comments on the source PR timeline.

## Requirements

### Workflow permissions

```yaml
permissions:
  contents: write
  pull-requests: write

Checkout

Use fetch-depth: 0.

- uses: actions/checkout@v4
  with:
    fetch-depth: 0

Inputs (v3.0.0)

Input   Required        Default Description
token   Yes             GitHub token (e.g.: secrets.GITHUB_TOKEN)
pr_number       Yes             Source PR number (accepts N or #N)
attached_file_path      Yes             Path to the file to attach/commit in the repo
branch_convention_prefix        No      ops/files       Prefix for publication branches
pr_title        No      üõ°Ô∏è Automated Pull Request        Title of the derived PR
pr_template_path        Yes             Path to the PR body template
timeline_template_path  Yes             Path to the timeline comment template
bot_name        No      git-pr-ops-bot  Commit author name
bot_email       No      git-pr-ops@users.noreply.github.com     Commit author email
errors  No      .github/workflows/errors.log    File to centralize error logs via ops-errors

Templates

The Action renders templates via Malnati/templateer using environment variables.

PR body template (pr_template_path)

Variables:
        ‚Ä¢       ATTACHED_FILE_PATH (file basename only)
        ‚Ä¢       PR_NUMBER
        ‚Ä¢       BRANCH_CONVENTION

Example:

# üìé Published file

- File: `${ATTACHED_FILE_PATH}`
- Source PR: `#${PR_NUMBER}`
- Branch: `${BRANCH_CONVENTION}`

---
<div align="right">
  <sub>Generated by <b>Ops Publisher</b></sub>
</div>

Timeline template (timeline_template_path)

Variables:
        ‚Ä¢       ATTACHED_FILE_PATH (file basename only)
        ‚Ä¢       PR_NUMBER
        ‚Ä¢       BRANCH_CONVENTION
        ‚Ä¢       PR_URL (URL of the created/reused derived PR)

Example:

The branch for `${ATTACHED_FILE_PATH}` is `${BRANCH_CONVENTION}` and the derived Pull Request is ${PR_URL}.

> [!TIP]
> You can customize this message by creating a template file for it.

---
<div align="right">
  <sub>Processed by <b>Ops Publisher</b></sub>
</div>

Usage example

name: "Publish report"
on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate report
        shell: bash
        run: |
          mkdir -p .reports
          printf '%s\n' "hello report" > .reports/report.md

      - name: Publish
        uses: Malnati/ops-publisher@v3.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.issue.number }}
          attached_file_path: .reports/report.md
          pr_title: "üìã Report"
          branch_convention_prefix: ops/files
          pr_template_path: .github/templates/report-pr.md
          timeline_template_path: .github/templates/report-timeline.md
          bot_name: mbra-com-br
          bot_email: accounts@mbra.com.br
          errors: .errors/ops-publisher.log

Recommended conventions
        ‚Ä¢       Templates:
        ‚Ä¢       .github/templates/report-pr.md
        ‚Ä¢       .github/templates/report-timeline.md
        ‚Ä¢       Generated files:
        ‚Ä¢       .reports/* (or an equivalent folder, versioned/ignored per your strategy)
        ‚Ä¢       Error logs:
        ‚Ä¢       .errors/ops-publisher.log

Operational notes
        ‚Ä¢       If there are no changes to the file (git diff --cached --quiet), the Action will not create a commit or a new PR.
        ‚Ä¢       The derived PR is always opened with base = source branch of the source PR, forming an integration chain.
        ‚Ä¢       To centralize failures, use `errors` and collect this file as a workflow artifact when necessary.
