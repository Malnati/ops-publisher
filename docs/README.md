<!-- docs/README.md -->
# Ops Publisher

O **Ops Publisher** √© uma GitHub Action para publicar qualquer arquivo do reposit√≥rio (Markdown/JSON/CSV/etc) em uma **branch dedicada** e criar (ou reutilizar) uma **Pull Request derivada**, al√©m de publicar uma **mensagem no timeline** da PR fonte via template.

## Como funciona

1. L√™ a PR fonte via `pr_number` (usa `gh pr view`) e obt√©m:
   - `headRefName` (branch de origem da PR)
   - `baseRefName` (branch destino da PR)
2. Calcula uma branch de publica√ß√£o:
   - `branch_convention_prefix/<ultimos-10-do-sha-do-HEAD>`
3. Faz commit do arquivo em `attached_file_path` nessa branch e faz `push`.
4. Cria ou reaproveita uma PR derivada:
   - `base = headRefName` da PR fonte
   - `head = branch de publica√ß√£o`
5. Renderiza templates (corpo da PR e timeline) e comenta no timeline da PR fonte.

## Requisitos

### Permissions do workflow

```yaml
permissions:
  contents: write
  pull-requests: write

Checkout

Use fetch-depth: 0.

- uses: actions/checkout@v4
  with:
    fetch-depth: 0

Inputs (v3.0.0)

Input	Obrigat√≥rio	Padr√£o	Descri√ß√£o
token	Sim		Token GitHub (ex.: secrets.GITHUB_TOKEN)
pr_number	Sim		N√∫mero da PR fonte (aceita N ou #N)
attached_file_path	Sim		Caminho do arquivo a anexar/commitar no repo
branch_convention_prefix	N√£o	ops/files	Prefixo para branches de publica√ß√£o
pr_title	N√£o	üõ°Ô∏è Automated Pull Request	T√≠tulo da PR derivada
pr_template_path	Sim		Caminho do template do corpo da PR
timeline_template_path	Sim		Caminho do template do coment√°rio no timeline
bot_name	N√£o	git-pr-ops-bot	Nome do autor do commit
bot_email	N√£o	git-pr-ops@users.noreply.github.com	Email do autor do commit
errors	N√£o	.github/workflows/errors.log	Arquivo para centralizar logs de erro via ops-errors

Templates

A Action renderiza templates via Malnati/templateer com vari√°veis de ambiente.

Template do corpo da PR (pr_template_path)

Vari√°veis:
	‚Ä¢	ATTACHED_FILE_PATH (somente o basename do arquivo)
	‚Ä¢	PR_NUMBER
	‚Ä¢	BRANCH_CONVENTION

Exemplo:

# üìé Published file

- File: `${ATTACHED_FILE_PATH}`
- Source PR: `#${PR_NUMBER}`
- Branch: `${BRANCH_CONVENTION}`

---
<div align="right">
  <sub>Generated by <b>Ops Publisher</b></sub>
</div>

Template do timeline (timeline_template_path)

Vari√°veis:
	‚Ä¢	ATTACHED_FILE_PATH (somente o basename do arquivo)
	‚Ä¢	PR_NUMBER
	‚Ä¢	BRANCH_CONVENTION
	‚Ä¢	PR_URL (URL da PR derivada criada/reutilizada)

Exemplo:

A branch do arquivo `${ATTACHED_FILE_PATH}` √© `${BRANCH_CONVENTION}` e a Pull Request derivada √© ${PR_URL}.

> [!TIP]
> Pode-se modificar esta mensagem criando-se um arquivo de template para isto.

---
<div align="right">
  <sub>Processado por <b>Ops Publisher</b></sub>
</div>

Exemplo de uso

name: "Publish report"
on:
  issue_comment:
    types: [created]

permissions:
  contents: write
  pull-requests: write

jobs:
  publish:
    if: github.event.issue.pull_request != null
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate report
        shell: bash
        run: |
          mkdir -p .reports
          printf '%s\n' "hello report" > .reports/report.md

      - name: Publish
        uses: Malnati/ops-publisher@v3.0.0
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          pr_number: ${{ github.event.issue.number }}
          attached_file_path: .reports/report.md
          pr_title: "üìã Report"
          branch_convention_prefix: ops/files
          pr_template_path: .github/templates/report-pr.md
          timeline_template_path: .github/templates/report-timeline.md
          bot_name: mbra-com-br
          bot_email: accounts@mbra.com.br
          errors: .errors/ops-publisher.log

Conven√ß√µes recomendadas
	‚Ä¢	Templates:
	‚Ä¢	.github/templates/report-pr.md
	‚Ä¢	.github/templates/report-timeline.md
	‚Ä¢	Arquivos gerados:
	‚Ä¢	.reports/* (ou pasta equivalente versionada/ignorada conforme sua estrat√©gia)
	‚Ä¢	Logs de erro:
	‚Ä¢	.errors/ops-publisher.log

Notas operacionais
	‚Ä¢	Se n√£o houver altera√ß√µes no arquivo (git diff --cached --quiet), a Action n√£o cria commit nem PR nova.
	‚Ä¢	A PR derivada √© sempre aberta com base = branch de origem da PR fonte, formando uma cadeia de integra√ß√£o.
	‚Ä¢	Para centralizar falhas, use errors e colete esse arquivo como artifact no workflow quando necess√°rio.
